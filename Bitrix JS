<?
// ---------------------------
// 1) Подключаем "пролог" Битрикса
// ---------------------------
// Пролог поднимает ядро Bitrix: доступ к $APPLICATION, BX*, CJSCore, авторизации и т.д.
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");

// ---------------------------
// 2) Заголовок страницы
// ---------------------------
$APPLICATION->SetTitle("AJAX");

// ---------------------------
// 3) Подключаем JS-ядро с модулем ajax
// ---------------------------
// CJSCore::Init подключает нужные JS-библиотеки Bitrix на страницу.
// В частности — объект BX и BX.ajax.*
CJSCore::Init(array('ajax'));

// ---------------------------
// 4) Обработчик AJAX-запроса (серверная часть)
// ---------------------------
// Смысл: если на эту же страницу пришли данные "ajax_form=testAjax",
// то мы НЕ выводим страницу целиком, а возвращаем JSON и завершаем скрипт.
$sidAjax = 'testAjax';

// isset($_REQUEST['ajax_form']) — проверяем, что параметр вообще пришёл
// $_REQUEST['ajax_form'] == $sidAjax — что это именно "наш" AJAX-запрос
if (isset($_REQUEST['ajax_form']) && $_REQUEST['ajax_form'] == $sidAjax) {

    // Очищаем буфер вывода, чтобы в ответе не было HTML от страницы.
    // Нам нужен "чистый" JSON без лишнего мусора.
    $GLOBALS['APPLICATION']->RestartBuffer();

    // Отдаём JSON-ответ (Bitrix-функция конвертирует массив в JSON строку)
    // RESULT — что мы хотим показать на странице
    // ERROR — поле для ошибок (пока пустое)
    echo CUtil::PhpToJSObject(array(
        'RESULT' => 'HELLO',
        'ERROR'  => ''
    ));

    // die() — остановка выполнения скрипта. Важно для AJAX,
    // чтобы не подмешался footer/HTML ниже.
    die();
}
?>

<!-- ---------------------------
5) HTML-блоки на странице
---------------------------- -->
<div class="group">
    <!-- Сюда мы потом подставим результат (HELLO) -->
    <div id="block"></div>

    <!-- Это "индикатор загрузки" -->
    <div id="process">wait ... </div>
</div>

<script>
    // ---------------------------
    // 6) JS-часть: включаем отладку Bitrix JS
    // ---------------------------
    // Когда debug=true — BX.debug будет писать в консоль больше информации
    window.BXDEBUG = true;

    // ---------------------------
    // 7) Функция, которая стартует AJAX-запрос
    // ---------------------------
    function DEMOLoad(){

        // Скрываем блок с результатом (чтобы обновить его заново)
        BX.hide(BX("block"));

        // Показываем "wait..."
        BX.show(BX("process"));

        // BX.ajax.loadJSON делает AJAX-запрос и ожидает JSON в ответ.
        // 1) URL: текущая страница + параметр ajax_form=testAjax
        // 2) Data: null (ничего не отправляем)
        // 3) Callback: DEMOResponse — функция, которая обработает ответ
        BX.ajax.loadJSON(
            '<?= $APPLICATION->GetCurPage() ?>?ajax_form=<?= $sidAjax ?>',
            null,
            DEMOResponse
        );
    }

    // ---------------------------
    // 8) Callback: что делаем, когда сервер ответил
    // ---------------------------
    function DEMOResponse(data){

        // Пишем ответ в консоль
        BX.debug('AJAX-DEMOResponse', data);

        // Подставляем результат (HELLO) в div#block
        BX("block").innerHTML = data.RESULT;

        // Показываем блок с результатом
        BX.show(BX("block"));

        // Скрываем "wait..."
        BX.hide(BX("process"));

        // Генерируем кастомное событие 'DEMOUpdate'
        // Можно слушать это событие и делать доп. действия после обновления
        BX.onCustomEvent(
            BX(BX("block")),
            'DEMOUpdate'
        );
    }

    // ---------------------------
    // 9) Выполняем код, когда страница загрузилась
    // ---------------------------
    BX.ready(function(){

        // Прячем результат и индикатор при старте
        BX.hide(BX("block"));
        BX.hide(BX("process"));

        // ---------------------------
        // 10) Делегируем клик по элементу .css_ajax
        // ---------------------------
        // BX.bindDelegate слушает клики на document.body,
        // и если кликнули по элементу с class="css_ajax",
        // то вызывается наша функция.
        BX.bindDelegate(
            document.body,
            'click',
            {className: 'css_ajax'},
            function(e){

                // e может быть пустым в некоторых старых браузерах,
                // тогда берём window.event
                if(!e) e = window.event;

                // Запускаем AJAX-запрос
                DEMOLoad();

                // BX.PreventDefault — аналог event.preventDefault()
                // Отменяет стандартное действие клика
                return BX.PreventDefault(e);
            }
        );
    });
</script>

<!-- Кнопка/элемент, по клику на который запускается AJAX -->
<div class="css_ajax">click Me</div>

<?
/*
11) Подключаем "эпилог" Битрикса
Эпилог закрывает страницу: подключает footer, выводит служебные скрипты и т.д.
*/
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");
?>
